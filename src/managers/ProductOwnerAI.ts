import { query, type SDKMessage } from "@anthropic-ai/claude-code";
import { Task, TaskAnalysisResult, AgentConfig, PhaseDocument, ProjectPhase } from '../types/index.js';
import { TaskInstructionManager } from '../utils/TaskInstructionManager.js';
import { v4 as uuidv4 } from 'uuid';
import { BaseAI } from './BaseAI.js';
import { ComponentType } from '../types/logging.js';
import * as fs from 'fs/promises';
import * as path from 'path';
import { createHash } from 'crypto';

/**
 * ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚ªãƒ¼ãƒŠãƒ¼AIã‚¯ãƒ©ã‚¹
 * ãƒ¦ãƒ¼ã‚¶ã‹ã‚‰ã®è¦æ±‚ã‚’åˆ†æã—ã€å…·ä½“çš„ãªã‚¿ã‚¹ã‚¯ã«åˆ†å‰²ã™ã‚‹
 */
export class ProductOwnerAI extends BaseAI {
  private readonly config: AgentConfig;
  private readonly baseRepoPath: string;

  constructor(baseRepoPath: string, config?: Partial<AgentConfig>) {
    super();
    this.baseRepoPath = baseRepoPath;
    this.config = {
      systemPrompt: this.getDefaultSystemPrompt(),
      maxTurns: 10,
      allowedTools: ["Read", "Glob", "Grep", "LS", "Write"],
      ...config
    };
  }

  /**
   * .kugutsuãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ã‚¹ã‚’å–å¾—
   */
  private getKugutsuDir(): string {
    return path.join(this.baseRepoPath, '.kugutsu');
  }

  /**
   * ãƒ•ã‚§ãƒ¼ã‚ºãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’å–å¾—
   */
  private getPhaseDocumentPath(projectId: string): string {
    return path.join(this.getKugutsuDir(), `phase-${projectId}.json`);
  }

  /**
   * åˆ†æçµæœã®JSONãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’å–å¾—
   */
  private getAnalysisJsonPath(projectId: string): string {
    return path.join(this.getKugutsuDir(), 'projects', projectId, 'analysis.json');
  }

  /**
   * ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’ç”Ÿæˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ä¸€æ„ã®IDã‚’ç”Ÿæˆï¼‰
   */
  private generateProjectId(userRequest: string): string {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰MD5ãƒãƒƒã‚·ãƒ¥ã‚’ç”Ÿæˆï¼ˆåŒã˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯åŒã˜IDã«ãªã‚‹ï¼‰
    return createHash('md5').update(userRequest).digest('hex').substring(0, 8);
  }

  /**
   * .kugutsuãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’åˆæœŸåŒ–
   */
  private async initializeKugutsuDir(): Promise<void> {
    const kugutsuDir = this.getKugutsuDir();
    try {
      await fs.access(kugutsuDir);
    } catch {
      await fs.mkdir(kugutsuDir, { recursive: true });
      this.info('ğŸ“ .kugutsuãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã—ãŸ');
    }
  }

  /**
   * æ—¢å­˜ã®ãƒ•ã‚§ãƒ¼ã‚ºãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã‚€
   */
  private async loadPhaseDocument(projectId: string): Promise<PhaseDocument | null> {
    const docPath = this.getPhaseDocumentPath(projectId);
    try {
      const content = await fs.readFile(docPath, 'utf-8');
      const doc = JSON.parse(content) as PhaseDocument;
      this.success(`âœ… æ—¢å­˜ã®ãƒ•ã‚§ãƒ¼ã‚ºãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ (ãƒ•ã‚§ãƒ¼ã‚º ${doc.currentPhaseIndex + 1}/${doc.phases.length})`);
      return doc;
    } catch {
      return null;
    }
  }

  /**
   * ãƒ•ã‚§ãƒ¼ã‚ºãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä¿å­˜
   */
  private async savePhaseDocument(doc: PhaseDocument): Promise<void> {
    await this.initializeKugutsuDir();
    const docPath = this.getPhaseDocumentPath(doc.projectId);
    await fs.writeFile(docPath, JSON.stringify(doc, null, 2), 'utf-8');
    this.success(`âœ… ãƒ•ã‚§ãƒ¼ã‚ºãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ: ${path.relative(this.baseRepoPath, docPath)}`);
  }

  protected getComponentType(): ComponentType {
    return 'ProductOwner';
  }

  protected getId(): string {
    return 'ProductOwner';
  }

  /**
   * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
   */
  private getDefaultSystemPrompt(): string {
    return `ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚ªãƒ¼ãƒŠãƒ¼å…¼ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ã‹ã‚‰ã®é–‹ç™ºè¦æ±‚ã‚’åˆ†æã—ã€**ãƒ¦ãƒ¼ã‚¶ãŒæ±‚ã‚ã‚‹ã™ã¹ã¦ã®æ©Ÿèƒ½ã‚’å®Œæˆã¾ã§è²¬ä»»ã‚’æŒã¤**å®Ÿè¡Œå¯èƒ½ãªã‚¿ã‚¹ã‚¯ã«åˆ†å‰²ã—ã¦ã€ãƒãƒ¼ãƒ å†…ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«é©åˆ‡ã«ã‚¢ã‚µã‚¤ãƒ³ã™ã‚‹ã“ã¨ãŒä¸»ãªå½¹å‰²ã§ã™ã€‚

## ğŸ¯ å®Œå…¨æ©Ÿèƒ½å®Ÿè£…è²¬ä»»
**æœ€é‡è¦**: ã‚ãªãŸã¯**ãƒ¦ãƒ¼ã‚¶ãŒæ±‚ã‚ã‚‹ã™ã¹ã¦ã®æ©Ÿèƒ½ã‚’å®Ÿç”¨å¯èƒ½ãªãƒ¬ãƒ™ãƒ«ã¾ã§å®Œæˆã•ã›ã‚‹è²¬ä»»**ã‚’è² ã„ã¾ã™ã€‚
- **å®Œå…¨å®Ÿè£…ã®å®šç¾©**: ãƒ¦ãƒ¼ã‚¶ãŒè¦æ±‚ã—ãŸã™ã¹ã¦ã®æ©Ÿèƒ½ãŒå®Ÿéš›ã«å‹•ä½œã—ã€å®Ÿç”¨çš„ã«ä½¿ç”¨ã§ãã‚‹çŠ¶æ…‹
- **ã‚·ã‚¹ãƒ†ãƒ å®Œæˆè²¬ä»»**: åˆ†å‰²ã—ãŸã‚¿ã‚¹ã‚¯ãŒã™ã¹ã¦å®Ÿè£…å®Œäº†ã—ãŸæ™‚ç‚¹ã§ã€ãƒ¦ãƒ¼ã‚¶ãŒæ±‚ã‚ã‚‹ã‚¢ãƒ—ãƒªãƒ»ã‚·ã‚¹ãƒ†ãƒ ãŒå®Œå…¨ã«å‹•ä½œã™ã‚‹çŠ¶æ…‹
- **å®Ÿç”¨æ€§ä¿è¨¼**: å˜ãªã‚‹å‹•ä½œã§ã¯ãªãã€å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¥å¸¸çš„ã«ä½¿ç”¨ã§ãã‚‹å“è³ªãƒ¬ãƒ™ãƒ«
- **ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½æ€§**: æœ¬ç•ªç’°å¢ƒã§å®‰å®šå‹•ä½œã—ã€å®Ÿéš›ã«ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦æä¾›å¯èƒ½ãªçŠ¶æ…‹
- **ãƒ•ã‚§ãƒ¼ã‚ºæœ€çµ‚ç›®æ¨™**: ãƒ•ã‚§ãƒ¼ã‚ºåˆ†ã‘ã‚’è¡Œã†å ´åˆã‚‚ã€å…¨ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†æ™‚ã«ã¯è¦æ±‚ã•ã‚ŒãŸã™ã¹ã¦ã®æ©Ÿèƒ½ãŒå®Œæˆã—ã¦ã„ã‚‹çŠ¶æ…‹ã‚’å¿…ãšé”æˆã™ã‚‹

## ğŸ”’ ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿åˆ¶é™
**é‡è¦**: Writeãƒ„ãƒ¼ãƒ«ã®ä½¿ç”¨ã¯.kugutsuãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã«åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚
- è¨±å¯: .kugutsu/phase-*.json, .kugutsu/implementation-notes-*.md ç­‰
- ç¦æ­¢: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã€ãã®ä»–å…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«
- ç›®çš„: ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†ã¨å®Ÿè£…æ–¹é‡ã®è¨˜éŒ²ã®ã¿

## ğŸ¯ ä¸»è¦ãªè²¬å‹™

### 1. è¦ä»¶å®šç¾©ã¨åˆ†æ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æ±‚ã®æœ¬è³ªçš„ãªãƒ‹ãƒ¼ã‚ºã‚’ç†è§£ã—ã€æ›–æ˜§ãªéƒ¨åˆ†ã‚’æ˜ç¢ºåŒ–
- ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤ã¨æŠ€è¡“çš„å®Ÿç¾å¯èƒ½æ€§ã‚’è©•ä¾¡
- ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ã®æœŸå¾…å€¤ã¨åˆ¶ç´„æ¡ä»¶ã‚’æ•´ç†
- æˆåŠŸåŸºæº–ã¨å—ã‘å…¥ã‚Œæ¡ä»¶ã‚’å®šç¾©

### 2. æŠ€è¡“è¨­è¨ˆã¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æŒ‡å°
- æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹æ§‹é€ ã‚’ç†è§£ã—ã€ä¸€è²«æ€§ã®ã‚ã‚‹è¨­è¨ˆã‚’ææ¡ˆ
- æ‹¡å¼µæ€§ã€ä¿å®ˆæ€§ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’è€ƒæ…®ã—ãŸæŠ€è¡“é¸æŠ
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ã€ç›£è¦–å¯èƒ½æ€§ã®è¦³ç‚¹ã‚’çµ±åˆ
- ã‚³ãƒ¼ãƒ‰å“è³ªåŸºæº–ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®é©ç”¨

### 3. è¦ä»¶å®šç¾©å‹ã‚¿ã‚¹ã‚¯åˆ†å‰²ã¨ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚¢ã‚µã‚¤ãƒ³
- **æ©Ÿèƒ½è¦ä»¶ã®å®Œå…¨å®šç¾©**: å„ã‚¿ã‚¹ã‚¯ã§å®Ÿç¾ã™ã¹ãæ©Ÿèƒ½è¦ä»¶ã‚’æ˜ç¢ºã«å®šç¾©ã—ã€ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒãã®å®Ÿç¾æ–¹æ³•ã‚’æ±ºå®š
- **å…¨æ©Ÿèƒ½å®ŒæˆæŒ‡å‘**: ãƒ¦ãƒ¼ã‚¶ãŒæ±‚ã‚ã‚‹ã™ã¹ã¦ã®æ©Ÿèƒ½ã‚’å®Œæˆã•ã›ã‚‹æœ€é©ãªæˆ¦ç•¥çš„åˆ†å‰²
- **æ©Ÿèƒ½å®Œçµæ€§ã®ä¿è¨¼**: å„ã‚¿ã‚¹ã‚¯ãŒã²ã¨ã¤ã®å®Œçµã—ãŸæ©Ÿèƒ½è¦ä»¶ã‚’æº€ãŸã—ã€å®Ÿç”¨ãƒ¬ãƒ™ãƒ«ã§ä¾¡å€¤ã‚’æä¾›
- **å“è³ªè¦ä»¶ã®æ˜ç¢ºåŒ–**: å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½¿ç”¨ã§ãã‚‹å“è³ªãƒ¬ãƒ™ãƒ«ã®è¦ä»¶ã‚’æ˜ç¢ºã«å®šç¾©
- **ã‚·ã‚¹ãƒ†ãƒ çµ±åˆè¦ä»¶**: åˆ†é›¢ã•ã‚ŒãŸæ©Ÿèƒ½ãŒçµ±åˆã•ã‚Œã¦å®Œå…¨ãªã‚·ã‚¹ãƒ†ãƒ ã¨ã—ã¦å‹•ä½œã™ã‚‹è¦ä»¶ã‚’å®šç¾©
- **ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢è£é‡ã®å°Šé‡**: å…·ä½“çš„ãªå®Ÿè£…æ–¹æ³•ã€æŠ€è¡“é¸æŠã€ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã¯ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒæ±ºå®š

## ğŸ”§ åˆ†æã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

### Phase 1: æŠ€è¡“çš„å®Ÿç¾å¯èƒ½æ€§ã¨ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ç†è§£
1. **æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯é©åˆæ€§è©•ä¾¡**: è¦æ±‚æ©Ÿèƒ½ã¨æ—¢å­˜æŠ€è¡“ã®æ•´åˆæ€§ç¢ºèª
2. **å®Ÿè£…è¤‡é›‘åº¦åˆ¤å®š**: è¦æ±‚ã®æŠ€è¡“çš„é›£æ˜“åº¦ã¨å®Ÿç¾å¯èƒ½æ€§ã®è©•ä¾¡
3. **å¿…è¦ä¾å­˜é–¢ä¿‚ç‰¹å®š**: æ–°è¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ»ã‚µãƒ¼ãƒ“ã‚¹ãƒ»ã‚¤ãƒ³ãƒ•ãƒ©è¦ä»¶ã®æ´—ã„å‡ºã—
4. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å½±éŸ¿**: ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã¨å®‰å…¨æ€§ã®äº‹å‰è©•ä¾¡
5. **æ—¢å­˜è³‡æºæ´»ç”¨**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã€å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®ç‰¹å®š

### Phase 2: å…¨æ©Ÿèƒ½å®Œæˆæˆ¦ç•¥ã¨å®ŒæˆåŸºæº–è¨­å®š
1. **è¦æ±‚æ©Ÿèƒ½ã®å®Œå…¨å®šç¾©**: ãƒ¦ãƒ¼ã‚¶ãŒæ±‚ã‚ã‚‹ã™ã¹ã¦ã®æ©Ÿèƒ½ã‚’æ¼ã‚Œãªãç‰¹å®šã—ã€å®Ÿè£…å®Œæˆã¾ã§è²¬ä»»ã‚’æŒã¤
2. **å®Ÿç”¨ãƒ¬ãƒ™ãƒ«å®ŒæˆåŸºæº–**: ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ã‹ã¤å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¥å¸¸çš„ã«ä½¿ç”¨ã§ãã‚‹å“è³ªãƒ¬ãƒ™ãƒ«ã®æ˜ç¢ºåŒ–
3. **ã‚·ã‚¹ãƒ†ãƒ å®Œæˆä¿è¨¼**: ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ç‚¹ã§ã€è¦æ±‚ã•ã‚ŒãŸã‚¢ãƒ—ãƒªãƒ»ã‚·ã‚¹ãƒ†ãƒ ãŒå®Œå…¨ã«å‹•ä½œã™ã‚‹çŠ¶æ…‹ã®è¨­è¨ˆ
4. **å“è³ªã‚²ãƒ¼ãƒˆã®è¨­å®š**: å®Ÿç”¨ãƒ¬ãƒ™ãƒ«ã«å¿…è¦ãªãƒ†ã‚¹ãƒˆãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»UXåŸºæº–ã®å®šç¾©
5. **çµ±åˆã‚·ã‚¹ãƒ†ãƒ æˆ¦ç•¥**: åˆ†å‰²ã•ã‚ŒãŸæ©Ÿèƒ½ãŒçµ±åˆã•ã‚Œã€å®Œå…¨ãªã‚·ã‚¹ãƒ†ãƒ ã¨ã—ã¦å‹•ä½œã™ã‚‹ã“ã¨ã‚’ä¿è¨¼ã™ã‚‹è¨ˆç”»

### Phase 3: ã‚·ã‚¹ãƒ†ãƒ å®Œæˆä¿è¨¼å‹ã‚¿ã‚¹ã‚¯è¨­è¨ˆæˆ¦ç•¥
1. **å®Ÿç”¨ãƒ¬ãƒ™ãƒ«å®Œæˆã‚¿ã‚¹ã‚¯è¨­è¨ˆ**: å„ã‚¿ã‚¹ã‚¯ãŒå®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½¿ç”¨ã§ãã‚‹ãƒ¬ãƒ™ãƒ«ã¾ã§æ©Ÿèƒ½ã‚’å®Œå…¨å®Ÿè£…
2. **ã‚·ã‚¹ãƒ†ãƒ çµ±åˆå®Œæˆ**: å„ã‚¿ã‚¹ã‚¯ã«ä»–æ©Ÿèƒ½ã¨ã®é€£æºãƒ†ã‚¹ãƒˆã¨ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®å‹•ä½œç¢ºèªã‚’å«ã‚ã‚‹
3. **æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å®Œå…¨æº–å‚™**: å„æ©Ÿèƒ½ãŒæœ¬ç•ªç’°å¢ƒã§å®‰å®šå‹•ä½œã—ã€å®Ÿéš›ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªçŠ¶æ…‹ã¾ã§å®Ÿè£…
4. **å®Ÿç”¨å“è³ªå®Œå‚™**: å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¥å¸¸çš„ã«ä½¿ç”¨ã§ãã‚‹ãƒ¬ãƒ™ãƒ«ã®UXãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»å …ç‰¢æ€§ã‚’å®Œå…¨å®Ÿè£…
5. **å…¨æ©Ÿèƒ½å®Œæˆè²¬ä»»**: ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ãŸæ™‚ç‚¹ã§ã€ãƒ¦ãƒ¼ã‚¶ãŒæ±‚ã‚ã‚‹ã‚¢ãƒ—ãƒªãƒ»ã‚·ã‚¹ãƒ†ãƒ ãŒå®Œå…¨ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ä¿è¨¼

## ğŸª å®Œå…¨æ©Ÿèƒ½å®Ÿè£…å‹ä¸¦åˆ—é–‹ç™ºæŒ‡é‡

### ğŸš€ ä¸¦åˆ—å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ã®æ´»ç”¨
**é‡è¦**: ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯é«˜åº¦ãªä¸¦åˆ—å‡¦ç†ã¨ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°æ©Ÿèƒ½ã‚’æŒã£ã¦ã„ã¾ã™ã€‚
- **è‡ªå‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°**: ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒç©ºãã¨è‡ªå‹•çš„ã«æ¬¡ã®ã‚¿ã‚¹ã‚¯ãŒå®Ÿè¡Œã•ã‚Œã‚‹
- **å„ªå…ˆåº¦ç®¡ç†**: é‡è¦ãªã‚¿ã‚¹ã‚¯ï¼ˆã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ¶ˆç­‰ï¼‰ãŒå„ªå…ˆçš„ã«å‡¦ç†ã•ã‚Œã‚‹
- **ç„¡åˆ¶é™ã‚¿ã‚¹ã‚¯**: å¿…è¦ãªæ©Ÿèƒ½ã‚’ã™ã¹ã¦ã‚¿ã‚¹ã‚¯åŒ–ã—ã¦ãã ã•ã„ï¼ˆã‚·ã‚¹ãƒ†ãƒ ãŒåŠ¹ç‡çš„ã«å‡¦ç†ï¼‰

### ğŸ¯ ã‚¿ã‚¹ã‚¯ç²’åº¦ã®åŸºæœ¬åŸå‰‡
- **å®Ÿç”¨ãƒ¬ãƒ™ãƒ«å®Œæˆã‚¿ã‚¹ã‚¯**: ç´°ã‹ã„ä½œæ¥­åˆ†å‰²ã§ã¯ãªãã€æ©Ÿèƒ½ã‚’å®Ÿç”¨å¯èƒ½ãªãƒ¬ãƒ™ãƒ«ã¾ã§å®Œå…¨å®Ÿè£…ã™ã‚‹è²¬ä»»ç¯„å›²
- **ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰å®Œæˆå®Ÿè£…**: ãƒ‡ãƒ¼ã‚¿å±¤ã‹ã‚‰UIå±¤ã€ãƒ†ã‚¹ãƒˆã€ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™ã¾ã§ä¸€ã¤ã®ã‚¿ã‚¹ã‚¯ã§å®Œå…¨ã«å®Œçµ
- **æœ€é©æ©Ÿèƒ½åˆ†å‰²**: ãƒ¦ãƒ¼ã‚¶ãŒæ±‚ã‚ã‚‹ã™ã¹ã¦ã®æ©Ÿèƒ½ã‚’åŠ¹ç‡çš„ã«å®Œæˆã•ã›ã‚‹æˆ¦ç•¥çš„åˆ†å‰²
- **ã‚·ã‚¹ãƒ†ãƒ çµ±åˆè²¬ä»»**: åˆ†å‰²ã•ã‚ŒãŸæ©Ÿèƒ½ãŒæœ€çµ‚çš„ã«çµ±åˆã•ã‚Œã€å®Œå…¨ãªã‚·ã‚¹ãƒ†ãƒ ã¨ã—ã¦å‹•ä½œã™ã‚‹ã“ã¨ã‚’ä¿è¨¼

### ğŸš€ è¦ä»¶å®šç¾©å‹ã‚¿ã‚¹ã‚¯ã®å…·ä½“ä¾‹
**è‰¯ã„ä¾‹ï¼ˆæ©Ÿèƒ½è¦ä»¶é‡è¦–ï¼‰**ï¼š
- ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ©Ÿèƒ½: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®‰å…¨ã«ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ã‚’è¡Œãˆã‚‹æ©Ÿèƒ½ã‚’å®Ÿç¾ã€
- ã€Œãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–åŸºç›¤: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨ãªä¿å­˜ãƒ»å–å¾—ãƒ»æ›´æ–°ã‚’å®Ÿç¾ã€
- ã€Œå•†å“ç®¡ç†æ©Ÿèƒ½: ç®¡ç†è€…ãŒå•†å“ã®ç™»éŒ²ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãƒ»æ¤œç´¢ã‚’ç›´æ„Ÿçš„ã«è¡Œãˆã‚‹æ©Ÿèƒ½ã‚’å®Ÿç¾ã€
- ã€Œæ±ºæ¸ˆå‡¦ç†æ©Ÿèƒ½: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®‰å…¨ã§ä¿¡é ¼ã§ãã‚‹æ±ºæ¸ˆå‡¦ç†ã‚’é€šã˜ã¦å•†å“è³¼å…¥ã‚’å®Œäº†ã§ãã‚‹æ©Ÿèƒ½ã‚’å®Ÿç¾ã€

**é¿ã‘ã‚‹ã¹ãä¾‹ï¼ˆå®Ÿè£…è©³ç´°ã‚’å«ã‚€åˆ†å‰²ï¼‰**ï¼š
- ã€ŒPrismaã‚¹ã‚­ãƒ¼ãƒã®ä½œæˆã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã€
- ã€ŒJWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã£ãŸèªè¨¼APIã®å®Ÿè£…ã€
- ã€ŒReact Hookã‚’ä½¿ã£ãŸãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®ä½œæˆã€

### ğŸ—ï¸ å…¨æ©Ÿèƒ½å®Œæˆæˆ¦ç•¥
- **æœ€é©æ©Ÿèƒ½åˆ†å‰²**: æ©Ÿèƒ½ã®è¤‡é›‘ã•ã¨ä¾å­˜é–¢ä¿‚ã‚’è€ƒæ…®ã—ã¦ã€æœ€ã‚‚åŠ¹ç‡çš„ãªç²’åº¦ã§è¦ä»¶ã‚’åˆ†å‰²
- **æ©Ÿèƒ½è¦ä»¶ã®ç‹¬ç«‹æ€§**: å„æ©Ÿèƒ½è¦ä»¶ãŒç‹¬ç«‹ã—ã¦ä¾¡å€¤ã‚’æä¾›ã—ã€æœ€çµ‚çš„ã«çµ±åˆã•ã‚Œã‚‹è¨­è¨ˆ
- **ã‚·ã‚¹ãƒ†ãƒ çµ±åˆè¦ä»¶**: åˆ†å‰²ã•ã‚ŒãŸæ©Ÿèƒ½ãŒçµ±åˆã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãŒæ±‚ã‚ã‚‹å®Œå…¨ãªã‚·ã‚¹ãƒ†ãƒ ã¨ã—ã¦å‹•ä½œã™ã‚‹è¦ä»¶å®šç¾©
- **å®Ÿè£…è‡ªç”±åº¦ã®ä¿è¨¼**: å„ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒæœ€é©ã¨åˆ¤æ–­ã™ã‚‹æŠ€è¡“ãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§è¦ä»¶ã‚’å®Ÿç¾
- **ä¸¦åˆ—å‡¦ç†åŠ¹ç‡**: ã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•çš„ã«ã‚¿ã‚¹ã‚¯ã‚’ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°ã—ã€åŠ¹ç‡çš„ãªä¸¦åˆ—å®Ÿè¡Œã‚’ç®¡ç†
- **ã‚¿ã‚¹ã‚¯æ•°åˆ¶é™ãªã—**: å¿…è¦ãªæ©Ÿèƒ½ã‚’ã™ã¹ã¦åˆ†å‰²ã—ã¦ã‚¿ã‚¹ã‚¯åŒ–ï¼ˆã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•çš„ã«ä¸¦åˆ—å®Ÿè¡Œã‚’åˆ¶å¾¡ï¼‰

## ğŸ“‹ ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¸ã®è¦ä»¶å®šç¾©å“è³ª

å„ã‚¿ã‚¹ã‚¯ã«ã¯ä»¥ä¸‹ã‚’æ˜ç¢ºã«å«ã‚ã€ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒè‡ªå¾‹çš„ã«å®Ÿè£…ã§ãã‚‹è¦ä»¶ã‚’å®šç¾©ã™ã‚‹ï¼š
- **æ©Ÿèƒ½è¦ä»¶ã®æ˜ç¢ºåŒ–**: å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½•ã‚’ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‹ã®å…·ä½“çš„ãªè¦ä»¶å®šç¾©
- **å“è³ªè¦ä»¶ã®å®šç¾©**: å®Ÿç”¨ãƒ¬ãƒ™ãƒ«ã§å¿…è¦ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€å®‰å…¨æ€§ã€ä½¿ã„ã‚„ã™ã•ã®è¦ä»¶åŸºæº–
- **å—ã‘å…¥ã‚Œæ¡ä»¶ã®æ˜ç¤º**: æ©Ÿèƒ½ãŒå®Œæˆã—ãŸã¨åˆ¤æ–­ã™ã‚‹ãŸã‚ã®å…·ä½“çš„ãªå—ã‘å…¥ã‚Œæ¡ä»¶
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼**: å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãã®æ©Ÿèƒ½ã‚’ã©ã®ã‚ˆã†ã«ä½¿ç”¨ã™ã‚‹ã‹ã®ã‚·ãƒŠãƒªã‚ª
- **ã‚·ã‚¹ãƒ†ãƒ çµ±åˆè¦ä»¶**: ä»–æ©Ÿèƒ½ã¨ã®é€£æºã‚„çµ±åˆæ™‚ã«æº€ãŸã™ã¹ãè¦ä»¶ã®å®šç¾©
- **åˆ¶ç´„æ¡ä»¶ã®æ˜ç¤º**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€æ³•è¦åˆ¶ã€æŠ€è¡“çš„åˆ¶ç´„ãªã©è€ƒæ…®ã™ã¹ãåˆ¶ç´„æ¡ä»¶
- **æˆåŠŸåŸºæº–ã®è¨­å®š**: æ©Ÿèƒ½ãŒæœŸå¾…é€šã‚Šã«å‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®åŸºæº–

**é‡è¦**: å…·ä½“çš„ãªæŠ€è¡“é¸æŠã€å®Ÿè£…æ–¹æ³•ã€ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒæ±ºå®šã—ã¾ã™ã€‚

## ğŸ” æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯åˆ†æã®å¿…é ˆè¦ä»¶

### ğŸ“‹ äº‹å‰èª¿æŸ»ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
**åˆ†æé–‹å§‹å‰ã«ä»¥ä¸‹ã‚’å¿…ãšç¢ºèª**ï¼š

1. **æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯é©åˆæ€§**ï¼š
   - package.json/requirements.txtç­‰ã§æ—¢å­˜ä¾å­˜é–¢ä¿‚ã‚’ç¢ºèª
   - ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨è¦æ±‚æ©Ÿèƒ½ã®æ•´åˆæ€§è©•ä¾¡
   - æ–°è¦å°å…¥ãŒå¿…è¦ãªæŠ€è¡“ã®å®Ÿç¾å¯èƒ½æ€§åˆ¤å®š

2. **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ¶ç´„**ï¼š
   - æ—¢å­˜ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ãƒ»è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã®æ•´åˆæ€§
   - APIè¨­è¨ˆãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã¨ã®è¦ªå’Œæ€§
   - ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ»ã‚¤ãƒ³ãƒ•ãƒ©åˆ¶ç´„ã®ç¢ºèª

3. **å®Ÿè£…è¤‡é›‘åº¦è©•ä¾¡**ï¼š
   - è¦æ±‚æ©Ÿèƒ½ã®æŠ€è¡“çš„é›£æ˜“åº¦ï¼ˆç°¡å˜/æ™®é€š/è¤‡é›‘/é«˜åº¦ï¼‰ã‚’åˆ¤å®š
   - å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹çµ±åˆãƒ»ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ç­‰ã®ç‰¹æ®Šè¦ä»¶ã‚’ç‰¹å®š
   - æ—¢å­˜ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã§ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ç¢ºèª

### ğŸš¨ å®Ÿç¾å›°é›£åˆ¤å®šåŸºæº–
ä»¥ä¸‹ã®å ´åˆã¯æ˜ç¢ºã«æŒ‡æ‘˜ã—ã€ä»£æ›¿æ¡ˆã‚’æç¤ºï¼š
- æ—¢å­˜æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã§ã¯å®Ÿç¾å›°é›£ãªè¦æ±‚
- é«˜åº¦ãªå°‚é–€æŠ€è¡“ï¼ˆAI/MLã€ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ç­‰ï¼‰ãŒå¿…è¦
- å¤§è¦æ¨¡ãªè¨­è¨ˆå¤‰æ›´ãŒå¿…è¦ãªè¦æ±‚
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä¸Šã®ãƒªã‚¹ã‚¯ãŒé«˜ã„å®Ÿè£…

ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã‚’ç†è§£ã™ã‚‹ãŸã‚ã€Readã€Globã€Grepãƒ„ãƒ¼ãƒ«ã‚’ç©æ¥µçš„ã«ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª¿æŸ»ã—ã¦ãã ã•ã„ã€‚
æŠ€è¡“çš„å®Ÿç¾å¯èƒ½æ€§ã‚’å¿…ãšè©•ä¾¡ã—ã€ä¸Šè¨˜ã§æŒ‡å®šã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã«åˆ†æçµæœã‚’JSONå½¢å¼ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚`;
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ã‹ã‚‰ã®è¦æ±‚ã‚’åˆ†æã—ã¦ã‚¿ã‚¹ã‚¯ã«åˆ†å‰²ã—ã€æŒ‡ç¤ºãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
   */
  async analyzeUserRequestWithInstructions(
    userRequest: string,
    instructionManager?: TaskInstructionManager
  ): Promise<TaskAnalysisResult> {
    this.info('ğŸ§  è¦æ±‚åˆ†æé–‹å§‹');

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’ç”Ÿæˆã—ã€æ—¢å­˜ã®ãƒ•ã‚§ãƒ¼ã‚ºãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèª
    const projectId = this.generateProjectId(userRequest);
    const existingDoc = await this.loadPhaseDocument(projectId);

    // instructionManagerãŒæ¸¡ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ä½œæˆ
    let localInstructionManager = instructionManager;
    if (!localInstructionManager) {
      localInstructionManager = new TaskInstructionManager(this.baseRepoPath, projectId);
    }
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å–å¾—
    const sessionId = localInstructionManager.sessionId;

    let prompt: string;
    if (existingDoc) {
      // æ—¢å­˜ã®ãƒ•ã‚§ãƒ¼ã‚ºãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã¯ç¶šãã‹ã‚‰å®Ÿè¡Œ
      prompt = this.buildContinuationPrompt(userRequest, existingDoc, sessionId);
    } else {
      // projectsdirã‚’ä½œæˆ
      const projectsDir = path.join(this.getKugutsuDir(), 'projects', projectId);
      await fs.mkdir(projectsDir, { recursive: true });
      prompt = this.buildAnalysisPrompt(userRequest, projectId, sessionId);
    }

    try {
      const messages: SDKMessage[] = [];
      let fullAnalysis = '';

      for await (const message of query({
        prompt,
        abortController: new AbortController(),
        options: {
          maxTurns: this.config.maxTurns,
          cwd: this.baseRepoPath,
          allowedTools: ["Read", "Glob", "Grep", "LS", "Write"],
        },
      })) {
        messages.push(message);

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚ªãƒ¼ãƒŠãƒ¼AIã®æ€è€ƒéç¨‹ã‚’è¡¨ç¤º
        if (message && typeof message === 'object' && 'type' in message) {
          const analysisText = this.displayMessageActivity(message as any);
          if (analysisText) {
            fullAnalysis += analysisText + '\n';
          }
        }
      }

      // ã‚¿ã‚¹ã‚¯ã‚’è§£æãƒ»ä½œæˆ
      const result = await this.extractTaskAnalysisResultFromFile(projectId, messages);
      result.projectId = projectId; // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’çµæœã«å«ã‚ã‚‹
      result.sessionId = sessionId; // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’çµæœã«å«ã‚ã‚‹

      // ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†ã®å‡¦ç†
      const phaseInfo = await this.extractPhaseInfoFromFile(projectId);

      if (phaseInfo && !existingDoc) {
        // æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã®ã¿ãƒ•ã‚§ãƒ¼ã‚ºãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
        const doc = await this.createOrUpdatePhaseDocument(projectId, userRequest, phaseInfo, result, existingDoc);
        await this.savePhaseDocument(doc);

        // ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ã‚’ãƒ­ã‚°å‡ºåŠ›
        const currentPhase = doc.phases[doc.currentPhaseIndex];
        this.info(`ğŸ“Š ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚º: ${currentPhase.phaseName} (${currentPhase.currentPhase}/${currentPhase.totalPhases})`);
        this.info(`ğŸ“ ãƒ•ã‚§ãƒ¼ã‚ºã®èª¬æ˜: ${currentPhase.description}`);
      } else if (existingDoc) {
        // æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ
        // ProductOwnerAIãŒå®Ÿè£…çŠ¶æ³ã‚’ç¢ºèªã—ã¦ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’åˆ¤æ–­
        const currentPhaseInfo = this.extractCurrentPhaseFromAnalysis(messages);
        if (currentPhaseInfo && currentPhaseInfo.phaseNumber) {
          // ãƒ•ã‚§ãƒ¼ã‚ºã®é€²æ—ã‚’æ›´æ–°
          const newPhaseIndex = currentPhaseInfo.phaseNumber - 1;
          if (newPhaseIndex !== existingDoc.currentPhaseIndex) {
            existingDoc.currentPhaseIndex = newPhaseIndex;
            existingDoc.updatedAt = new Date();
            await this.savePhaseDocument(existingDoc);
            this.success(`âœ… ãƒ•ã‚§ãƒ¼ã‚ºã‚’æ›´æ–°ã—ã¾ã—ãŸ: ãƒ•ã‚§ãƒ¼ã‚º ${newPhaseIndex + 1}`);
          }
        }

        // ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ã®æ›´æ–°ãŒã‚ã‚Œã°åæ˜ 
        const updatedPhaseInfo = await this.extractPhaseInfoFromFile(projectId);
        if (updatedPhaseInfo && updatedPhaseInfo.phases) {
          // æ—¢å­˜ã®ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ã‚’æ›´æ–°
          await this.updatePhaseDocument(existingDoc, updatedPhaseInfo, result);
          this.info('ğŸ”„ ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        }

        const currentPhase = existingDoc.phases[existingDoc.currentPhaseIndex];
        this.info(`ğŸ“Š ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚º: ${currentPhase.phaseName} (${currentPhase.currentPhase}/${currentPhase.totalPhases})`);
      }

      // æ¦‚è¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
      await localInstructionManager.createOverviewFile(userRequest, fullAnalysis);

      // å„ã‚¿ã‚¹ã‚¯ã®è©³ç´°æŒ‡ç¤ºãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
      for (const task of result.tasks) {
        const detailedInstructions = await this.generateDetailedInstructions(task, userRequest, fullAnalysis);
        await localInstructionManager.createTaskInstructionFile(task, detailedInstructions);
      }

      // ä¾å­˜é–¢ä¿‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
      await localInstructionManager.createDependencyFile(result.tasks);

      this.success('âœ… åˆ†æå®Œäº† & æŒ‡ç¤ºãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå®Œäº†');
      return result;

    } catch (error) {
      this.error('âŒ åˆ†æã‚¨ãƒ©ãƒ¼', { error: error instanceof Error ? error.message : String(error) });
      throw error; // ã‚¨ãƒ©ãƒ¼ã‚’ãã®ã¾ã¾ä¼æ’­
    }
  }

  /**
   * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’è¡¨ç¤º
   */
  private displayMessageActivity(message: any): string | null {
    const messageType = message.type;
    let analysisText = '';

    switch (messageType) {
      case 'user':
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå…¥åŠ›ï¼‰
        if (message.message && message.message.content) {
          for (const content of message.message.content) {
            if (content.type === 'text') {
              this.info(`ğŸ“ å…¥åŠ›å—ä¿¡ - ${this.truncateText(content.text, 100)}`);
            }
          }
        }
        break;

      case 'assistant':
        // ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå‡ºåŠ›ãƒ»æ€è€ƒï¼‰
        if (message.message && message.message.content) {
          for (const content of message.message.content) {
            if (content.type === 'text') {
              const text = content.text;
              this.info(`ğŸ’­ ${this.truncateText(text, 200)}`);
              analysisText += text;
            } else if (content.type === 'tool_use') {
              const toolName = content.name;
              const toolId = content.id;
              const toolInput = content.input || {};
              const toolExecutionId = this.logToolExecution(toolName, `ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œ`);
              this.displayToolExecutionDetails(toolName, toolInput, toolId, toolExecutionId);
            }
          }
        }
        break;

      case 'tool_result':
        // ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œçµæœ
        if (message.content) {
          for (const content of message.content) {
            if (content.type === 'tool_result') {
              const toolUseId = content.tool_use_id;
              const isError = content.is_error;
              const status = isError ? 'âŒ ã‚¨ãƒ©ãƒ¼' : 'âœ… æˆåŠŸ';
              const result = content.content;

              this.info(`ğŸ“Š ãƒ„ãƒ¼ãƒ«çµæœ - ${status}`);

              if (isError) {
                this.error(`   âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°: ${this.truncateText(String(result), 150)}`);
              } else {
                this.displayToolResult(result, toolUseId, '');
              }
            }
          }
        }
        break;

      case 'error':
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        this.error(`âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ`);
        if (message.error) {
          this.error(`   âŒ ã‚¨ãƒ©ãƒ¼: ${this.truncateText(String(message.error), 200)}`);
        }
        break;

      case 'system':
        // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        this.info(`âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥`);
        if (message.content) {
          this.info(`   ğŸ“‹ å†…å®¹: ${this.truncateText(String(message.content), 150)}`);
        }
        break;

      case 'thinking':
        // æ€è€ƒéç¨‹ï¼ˆå†…éƒ¨å‡¦ç†ï¼‰
        this.info(`ğŸ¤” åˆ†æä¸­...`);
        break;

      case 'event':
        // ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥
        if (message.event_type) {
          this.info(`ğŸ“¢ ã‚¤ãƒ™ãƒ³ãƒˆ - ${message.event_type}`);
        }
        break;

      case 'result':
        // æ—§å½¢å¼ã®çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
        analysisText += (message as any).result || '';
        break;

      default:
        // æœªçŸ¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—
        this.warn(`ğŸ” æœªçŸ¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ— - ${messageType}`);
        break;
    }

    return analysisText || null;
  }

  /**
   * ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œã®è©³ç´°ã‚’è¡¨ç¤º
   */
  private displayToolExecutionDetails(toolName: string, toolInput: any, _toolId: string, toolExecutionId: string): void {
    switch (toolName) {
      case 'Read':
        this.logToolResult(`   ğŸ“– ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿å–ã‚Š: ${toolInput.file_path || 'ãƒ‘ã‚¹ä¸æ˜'}`, toolExecutionId, toolName);
        break;

      case 'Glob':
        this.logToolResult(`   ğŸ” ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢: ${toolInput.pattern || 'ãƒ‘ã‚¿ãƒ¼ãƒ³ä¸æ˜'}`, toolExecutionId, toolName);
        if (toolInput.path) {
          this.logToolResult(`   ğŸ“ æ¤œç´¢ãƒ‘ã‚¹: ${toolInput.path}`, toolExecutionId, toolName);
        }
        break;

      case 'Grep':
        this.logToolResult(`   ğŸ” å†…å®¹æ¤œç´¢: ${toolInput.pattern || 'ãƒ‘ã‚¿ãƒ¼ãƒ³ä¸æ˜'}`, toolExecutionId, toolName);
        if (toolInput.include) {
          this.logToolResult(`   ğŸ“‚ å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: ${toolInput.include}`, toolExecutionId, toolName);
        }
        break;

      case 'LS':
        this.logToolResult(`   ğŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸€è¦§: ${toolInput.path || 'ãƒ‘ã‚¹ä¸æ˜'}`, toolExecutionId, toolName);
        break;

      default:
        this.logToolResult(`   âš™ï¸  ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: ${JSON.stringify(toolInput).substring(0, 100)}...`, toolExecutionId, toolName);
        break;
    }
  }

  /**
   * ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œçµæœã‚’è¡¨ç¤º
   */
  private displayToolResult(result: any, _toolId: string, toolExecutionId: string): void {
    if (typeof result === 'string') {
      const lines = result.split('\n');
      const lineCount = lines.length;

      if (lineCount === 1) {
        this.logToolResult(`   âœ… çµæœ: ${this.truncateText(result, 100)}`, toolExecutionId);
      } else if (lineCount <= 5) {
        this.logToolResult(`   âœ… çµæœ: ${lineCount}è¡Œã®å‡ºåŠ›`, toolExecutionId);
        lines.forEach(line => {
          if (line.trim()) {
            this.logToolResult(`   â”‚ ${this.truncateText(line, 80)}`, toolExecutionId);
          }
        });
      } else {
        this.logToolResult(`   âœ… çµæœ: ${lineCount}è¡Œã®å‡ºåŠ›ï¼ˆæŠœç²‹ï¼‰`, toolExecutionId);
        lines.slice(0, 3).forEach(line => {
          if (line.trim()) {
            this.logToolResult(`   â”‚ ${this.truncateText(line, 80)}`, toolExecutionId);
          }
        });
        this.logToolResult(`   â”‚ ... (ä»–${lineCount - 3}è¡Œ)`, toolExecutionId);
      }
    } else if (typeof result === 'object' && result !== null) {
      this.logToolResult(`   âœ… çµæœ: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼`, toolExecutionId);
      const preview = JSON.stringify(result, null, 2);
      this.logToolResult(`   â”‚ ${this.truncateText(preview, 150)}`, toolExecutionId);
    } else {
      this.logToolResult(`   âœ… çµæœ: ${String(result)}`, toolExecutionId);
    }
  }

  /**
   * ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ‡å®šã•ã‚ŒãŸé•·ã•ã§åˆ‡ã‚Šè©°ã‚ã‚‹
   */
  private truncateText(text: string, maxLength: number): string {
    if (text.length <= maxLength) {
      return text;
    }
    return text.substring(0, maxLength) + '...';
  }

  /**
   * åˆ†æç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
   */
  private buildAnalysisPrompt(userRequest: string, projectId: string, sessionId?: string): string {
    return `
ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚ªãƒ¼ãƒŠãƒ¼ã¨ã—ã¦ã€ä»¥ä¸‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æ±‚ã‚’åŒ…æ‹¬çš„ã«åˆ†æã—ã€ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒãƒ¼ãƒ ã«å¯¾ã™ã‚‹å…·ä½“çš„ãªå®Ÿè£…æŒ‡ç¤ºã‚’ç­–å®šã—ã¦ãã ã•ã„ï¼š

## ğŸ“ ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æ±‚
${userRequest}

## ğŸ” åˆ†æãƒ—ãƒ­ã‚»ã‚¹

### 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æ±‚ã®ç†è§£
- è¦æ±‚ã®æœ¬è³ªçš„ãªç›®çš„ã¨æœŸå¾…ã•ã‚Œã‚‹æˆæœã‚’ç†è§£
- æ½œåœ¨çš„ãªãƒ‹ãƒ¼ã‚ºã‚„åˆ¶ç´„æ¡ä»¶ã‚’è€ƒæ…®
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨å„ªå…ˆé †ä½ã‚’æŠŠæ¡

### 2. æŠ€è¡“çš„å®Ÿç¾å¯èƒ½æ€§ã®æ¤œè¨
- æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã‚’èª¿æŸ»ã—ã€æœ€é©ãªå®Ÿè£…æ–¹æ³•ã‚’æ¤œè¨
- å¿…è¦ãªæŠ€è¡“ã‚„ãƒ„ãƒ¼ãƒ«ã‚’ç‰¹å®š
- ãƒªã‚¹ã‚¯ã¨åˆ¶ç´„äº‹é …ã‚’è©•ä¾¡

### 3. ã‚¿ã‚¹ã‚¯è¨­è¨ˆ
- è¦æ±‚ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«å¿…è¦ãªä½œæ¥­ã‚’æ´—ã„å‡ºã—
- å„ä½œæ¥­ã‚’é©åˆ‡ãªç²’åº¦ã®ã‚¿ã‚¹ã‚¯ã«åˆ†å‰²
- ã‚¿ã‚¹ã‚¯é–“ã®ä¾å­˜é–¢ä¿‚ã‚’æ˜ç¢ºåŒ–

## ğŸ¯ ã‚¿ã‚¹ã‚¯åˆ†å‰²ã¨ã‚¢ã‚µã‚¤ãƒ³æˆ¦ç•¥

### âš–ï¸ å®Ÿè·µçš„ãƒ•ã‚¡ã‚¤ãƒ«ç«¶åˆç®¡ç†ï¼ˆãƒ™ã‚¹ãƒˆã‚¨ãƒ•ã‚©ãƒ¼ãƒˆï¼‰
**é‡è¦**: ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ¶ˆæ©Ÿèƒ½ãŒã‚ã‚‹ã“ã¨ã‚’å‰æã¨ã—ãŸç¾å®Ÿçš„ãªãƒãƒ©ãƒ³ã‚¹é‡è¦–

#### ğŸ¯ ç«¶åˆæœ€å°åŒ–ã®å„ªå…ˆé †ä½
1. **é«˜é »åº¦ç«¶åˆã®å›é¿**: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆpackage.json, tsconfig.jsonç­‰ï¼‰ã®åŒæ™‚ç·¨é›†ã¯æ¥µåŠ›é¿ã‘ã‚‹
2. **æ©Ÿèƒ½å¢ƒç•Œã®å°Šé‡**: å¯èƒ½ãªé™ã‚Šæ©Ÿèƒ½å˜ä½ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†é›¢
3. **åŠ¹ç‡æ€§ã¨ã®ä¸¡ç«‹**: å®Œå…¨å›é¿ã«ã“ã ã‚ã‚Šã™ãã¦éåŠ¹ç‡ã«ãªã‚‰ãªã„

#### ğŸ”§ è¨±å®¹å¯èƒ½ãªç«¶åˆã‚±ãƒ¼ã‚¹
- **å…±é€šãƒ•ã‚¡ã‚¤ãƒ«ã®è»½å¾®ãªå¤‰æ›´**: å‹å®šç¾©ã®è¿½åŠ ã€importæ–‡ã®è¿½åŠ ç­‰
- **ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸¦åˆ—æ›´æ–°**: ç•°ãªã‚‹æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆè¿½åŠ 
- **ã‚¹ã‚¿ã‚¤ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®éƒ¨åˆ†çš„æ›´æ–°**: ç‹¬ç«‹ã—ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ«
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®åŒæ™‚æ›´æ–°**: READMEã€APIä»•æ§˜æ›¸ç­‰

#### ğŸš¨ é¿ã‘ã‚‹ã¹ãé«˜ãƒªã‚¹ã‚¯ç«¶åˆ
- **åŒä¸€é–¢æ•°ãƒ»ã‚¯ãƒ©ã‚¹ã®åŒæ™‚ç·¨é›†**
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸¦åˆ—å®Ÿè¡Œ**
- **ãƒ“ãƒ«ãƒ‰è¨­å®šã®åŒæ™‚å¤‰æ›´**
- **èªè¨¼ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®ä¸­æ ¸æ©Ÿèƒ½**

### ğŸ“ å‹•çš„ã‚¿ã‚¹ã‚¯ç²’åº¦èª¿æ•´åŸå‰‡

#### ğŸ§  é–‹ç™ºã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ¤æ–­
**è¦æ±‚åˆ†ææ™‚ã«ä»¥ä¸‹ã‚’åˆ¤æ–­ã—ã€é©åˆ‡ãªæˆ¦ç•¥ã‚’é¸æŠ**ï¼š

1. **é–‹ç™ºè¦æ¨¡ã®ç‰¹å®š**ï¼š
   - å¤§è¦æ¨¡é–‹ç™ºï¼ˆã‚¢ãƒ—ãƒª0â†’MVPï¼‰â†’ æ©Ÿèƒ½å®Œçµå‹ã‚¿ã‚¹ã‚¯
   - ä¸­è¦æ¨¡é–‹ç™ºï¼ˆæ©Ÿèƒ½è¿½åŠ ï¼‰â†’ æ©Ÿèƒ½å˜ä½ã‚¿ã‚¹ã‚¯
   - å°è¦æ¨¡é–‹ç™ºï¼ˆãƒã‚°ä¿®æ­£ãƒ»æ”¹å–„ï¼‰â†’ ç´°ã‹ã„ç²’åº¦ã‚¿ã‚¹ã‚¯

2. **ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—ã®åˆ†æ**ï¼š
   - feature: é–‹ç™ºè¦æ¨¡ã«å¿œã˜ã¦ç²’åº¦èª¿æ•´
   - bugfix: å¸¸ã«ç´°ã‹ã„ç²’åº¦ï¼ˆè¿…é€Ÿä¿®æ­£å„ªå…ˆï¼‰
   - test/documentation: ç´°ã‹ã„ç²’åº¦
   - refactoring: ä¸­ç¨‹åº¦ã®ç²’åº¦

#### ğŸ¯ è¦æ¨¡åˆ¥æˆ¦ç•¥
- **å¤§è¦æ¨¡feature**: æ©Ÿèƒ½å®Œçµæ€§
- **ä¸­è¦æ¨¡feature**: æ©Ÿèƒ½å˜ä½
- **å°è¦æ¨¡ãƒ»bugfix**: ç´°ã‹ã„ç²’åº¦
- **ã‚¿ã‚¹ã‚¯æœ€é©åŒ–**: æ©Ÿèƒ½ã®è¤‡é›‘ã•ã¨é–‹ç™ºè¦æ¨¡ã«å¿œã˜ã¦æœ€ã‚‚åŠ¹ç‡çš„ãªæˆ¦ç•¥çš„åˆ†å‰²

### ğŸ¯ è¦ä»¶å®šç¾©å‹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢æŒ‡ç¤º
å„ã‚¿ã‚¹ã‚¯ã«ã¯ä»¥ä¸‹ã‚’å¿…ãšå«ã‚ã‚‹ï¼š

#### ğŸ“‹ æ©Ÿèƒ½è¦ä»¶å®šç¾©
- **æ©Ÿèƒ½è¦ä»¶**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½•ã‚’ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‹ã®æ˜ç¢ºãªå®šç¾©
- **å—ã‘å…¥ã‚ŒåŸºæº–**: æ©Ÿèƒ½å®Œæˆã®åˆ¤å®šåŸºæº–ï¼ˆWhatã€Whyé‡è¦–ï¼‰
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼**: å®Ÿéš›ã®ä½¿ç”¨ã‚·ãƒŠãƒªã‚ªã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“

#### âœ… å“è³ªè¦ä»¶å®šç¾©
- **å‹•ä½œè¦ä»¶**: æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã¨æ­£å¸¸ç³»ãƒ»ç•°å¸¸ç³»ã®è¦ä»¶
- **ä½¿ã„ã‚„ã™ã•è¦ä»¶**: ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ã¨ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£è¦ä»¶
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶**: ãƒ‡ãƒ¼ã‚¿ä¿è­·ã€èªè¨¼èªå¯ã€è„†å¼±æ€§å¯¾ç­–è¦ä»¶

#### ğŸ”— çµ±åˆè¦ä»¶å®šç¾©
- **ä»–æ©Ÿèƒ½ã¨ã®é€£æº**: å†…éƒ¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã§æº€ãŸã™ã¹ãé€£æºè¦ä»¶
- **å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ é€£æº**: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚„APIã¨ã®é€£æºè¦ä»¶
- **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§**: ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã§ã®ãƒ‡ãƒ¼ã‚¿ã®ä¸€è²«æ€§è¦ä»¶

**é‡è¦**: å…·ä½“çš„ãªå®Ÿè£…æ‰‹é †ã€æŠ€è¡“é¸æŠã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆã€é‹ç”¨æ–¹æ³•ã¯ã™ã¹ã¦ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒæ±ºå®šã—ã¾ã™ã€‚

## ğŸ“Š ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ

### ğŸ—‚ï¸ å¿…é ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ
åˆ†æå®Œäº†å¾Œã€ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’.kugutsuãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä½œæˆã—ã¦ãã ã•ã„ï¼š

1. **ãƒ•ã‚§ãƒ¼ã‚ºãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: .kugutsu/phase-{ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID}.json
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å…¨ä½“æ§‹æˆã¨ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±
   - ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºçŠ¶æ³ã¨é€²æ—ç®¡ç†
   - æ¬¡å›å®Ÿè¡Œæ™‚ã®ç¶™ç¶šã«å¿…è¦ãªæƒ…å ±

2. **è¦ä»¶ä»•æ§˜æ›¸**: .kugutsu/requirements-{ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID}.md
   - å„ãƒ•ã‚§ãƒ¼ã‚ºã®æ©Ÿèƒ½è¦ä»¶ã¨å“è³ªè¦ä»¶ã®è©³ç´°
   - ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã¨åˆ¶ç´„æ¡ä»¶
   - æ¬¡å›å®Ÿè¡Œæ™‚ã«è¦ä»¶ã‚’ç†è§£ã™ã‚‹ãŸã‚ã®é‡è¦ãªæƒ…å ±

### ğŸ“‹ ç¶™ç¶šå®Ÿè¡Œå¯¾å¿œ
- æ—¢å­˜ã®.kugutsuãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã€ç¶™ç¶šå®Ÿè¡Œã‹ã‚’åˆ¤æ–­
- ç¶™ç¶šå®Ÿè¡Œã®å ´åˆã¯å®Ÿè£…çŠ¶æ³ã‚’åˆ†æã—ã€é©åˆ‡ãªãƒ•ã‚§ãƒ¼ã‚ºã‹ã‚‰é–‹å§‹
- æ–°è¦ã®å ´åˆã¯æœ€åˆã®ãƒ•ã‚§ãƒ¼ã‚ºã‹ã‚‰é–‹å§‹

## ğŸ“Š æœ€çµ‚æˆæœç‰©è¦æ±‚

åˆ†æãŒå®Œäº†ã—ãŸã‚‰ã€ä»¥ä¸‹ã®JSONå½¢å¼ã§çµæœã‚’ Writeãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚

ä¿å­˜å…ˆãƒ•ã‚¡ã‚¤ãƒ«: ${this.getAnalysisJsonPath(projectId)}

é‡è¦: Writeãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã€ä¸Šè¨˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã«ä»¥ä¸‹ã®å½¢å¼ã®JSONã‚’ä¿å­˜ã—ã¦ãã ã•ã„ï¼š

\`\`\`json
{
  "sessionId": "${sessionId || ''}",
  "analysis": {
    "userRequestAnalysis": "ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æ±‚ã®è©³ç´°åˆ†æ",
    "codebaseAssessment": "ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®è©•ä¾¡",
    "technicalRequirements": "æŠ€è¡“è¦ä»¶ã®è©³ç´°",
    "architecturalDecisions": "è¨­è¨ˆåˆ¤æ–­ã¨æ ¹æ‹ "
  },
  "tasks": [
    {
      "id": "ä¸€æ„ã®ã‚¿ã‚¹ã‚¯IDï¼ˆUUIDã¾ãŸã¯çŸ­ã„ãƒãƒƒã‚·ãƒ¥å€¤ï¼‰",
      "title": "æ˜ç¢ºã§å…·ä½“çš„ãªã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ«",
      "description": "å®Ÿè£…ã™ã¹ãæ©Ÿèƒ½ã®è©³ç´°èª¬æ˜",
      "type": "feature|bugfix|documentation|test|refactoring",
      "priority": "high|medium|low",
      "skillRequirements": ["å¿…è¦ãªã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«"],
      "functionalRequirements": {
        "userStories": ["ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½•ã‚’ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‹"],
        "useCases": ["å…·ä½“çš„ãªä½¿ç”¨ã‚·ãƒŠãƒªã‚ª"],
        "businessRules": ["ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã¨åˆ¶ç´„æ¡ä»¶"]
      },
      "qualityRequirements": {
        "usability": ["ä½¿ã„ã‚„ã™ã•è¦ä»¶ï¼ˆUXã€ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ç­‰ï¼‰"],
        "security": ["ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ï¼ˆèªè¨¼ã€èªå¯ã€ãƒ‡ãƒ¼ã‚¿ä¿è­·ç­‰ï¼‰"]
      },
      "integrationRequirements": {
        "externalSystems": ["å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æºè¦ä»¶"],
        "internalModules": ["å†…éƒ¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã®é€£æºè¦ä»¶"],
        "dataFlow": ["ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã¨æ•´åˆæ€§è¦ä»¶"]
      },
      "dependencies": ["ä¾å­˜ã™ã‚‹ã‚¿ã‚¹ã‚¯ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå¾ªç’°ä¾å­˜ã‚’é¿ã‘ã‚‹ï¼‰"],
      "acceptanceCriteria": ["å…·ä½“çš„ãªå—ã‘å…¥ã‚ŒåŸºæº–ï¼ˆWhatã€Whyã‚’æ˜ç¢ºã«ï¼‰"],
      "constraints": ["æŠ€è¡“çš„åˆ¶ç´„ã€æ³•è¦åˆ¶ã€äºˆç®—åˆ¶ç´„ç­‰"],
      "successMetrics": ["æˆåŠŸã‚’æ¸¬å®šã™ã‚‹ãŸã‚ã®å…·ä½“çš„ãªæŒ‡æ¨™"]
    }
  ],
  "summary": "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®æ¦‚è¦ã¨å®Ÿè£…æˆ¦ç•¥",
  "riskAssessment": {
    "risks": ["ç‰¹å®šã•ã‚ŒãŸãƒªã‚¹ã‚¯"],
    "mitigations": ["ãƒªã‚¹ã‚¯è»½æ¸›ç­–"]
  },
  "parallelizationStrategy": "ä¸¦åˆ—é–‹ç™ºã®æˆ¦ç•¥ã¨åŠ¹æœ"
}
\`\`\`

## ğŸ“Š ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†

å¤§è¦æ¨¡ãªé–‹ç™ºã®å ´åˆã€ä»¥ä¸‹ã®æƒ…å ±ã‚’å«ã‚ã¦ãƒ•ã‚§ãƒ¼ã‚ºã«åˆ†å‰²ã—ã¦ãã ã•ã„ï¼š

\`\`\`json
{
  "phaseManagement": {
    "requiresPhases": true,
    "totalPhases": 3,
    "phases": [
      {
        "phaseNumber": 1,
        "phaseName": "åŸºç›¤æ§‹ç¯‰ãƒ•ã‚§ãƒ¼ã‚º",
        "description": "èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®åŸºç›¤ã¨ãªã‚‹ãƒ¢ãƒ‡ãƒ«ã¨APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å®Ÿè£…",
        "tasks": ["ã‚¿ã‚¹ã‚¯1ã®ã‚¿ã‚¤ãƒˆãƒ«", "ã‚¿ã‚¹ã‚¯2ã®ã‚¿ã‚¤ãƒˆãƒ«"],
      }
    ]
  }
}
\`\`\`

### ğŸ”„ ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ã®å‹•çš„æ›´æ–°
ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ã¯\`.kugutsu\`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã•ã‚Œã¾ã™ãŒã€ä»¥ä¸‹ã®å ´åˆã«ã¯ç©æ¥µçš„ã«æ›´æ–°ã—ã¦ãã ã•ã„ï¼š
- å®Ÿè£…çŠ¶æ³ã®ç¢ºèªçµæœã€å½“åˆã®æƒ³å®šã¨ç•°ãªã‚‹å ´åˆ
- æ–°ãŸãªæŠ€è¡“çš„èª²é¡Œã‚„æ©Ÿä¼šãŒç™ºè¦‹ã•ã‚ŒãŸå ´åˆ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æ±‚ã®å¤‰åŒ–ã‚„æ˜ç¢ºåŒ–ãŒã‚ã£ãŸå ´åˆ
- ä¾å­˜é–¢ä¿‚ã‚„å„ªå…ˆåº¦ã®è¦‹ç›´ã—ãŒå¿…è¦ãªå ´åˆ

ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é€²åŒ–ã«åˆã‚ã›ãŸæŸ”è»Ÿãªè¨ˆç”»å¤‰æ›´ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

### ğŸ¯ é–‹ç™ºè¦æ¨¡åˆ¥ã‚¿ã‚¹ã‚¯åˆ†å‰²æˆ¦ç•¥

#### ğŸ“Š ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—åˆ¥ç²’åº¦è¨­å®š

**ğŸš€ featureï¼ˆæ–°æ©Ÿèƒ½é–‹ç™ºï¼‰**ï¼š
- **å¤§è¦æ¨¡é–‹ç™ºï¼ˆã‚¢ãƒ—ãƒª0â†’MVPï¼‰**: æ©Ÿèƒ½å®Œçµå‹
  - ä¾‹ï¼šã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ©Ÿèƒ½ã®å®Œå…¨å®Ÿè£…ã€ã€Œå•†å“ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ä¸€å¼ã€
- **ä¸­è¦æ¨¡é–‹ç™ºï¼ˆæ©Ÿèƒ½è¿½åŠ ï¼‰**: æ©Ÿèƒ½å˜ä½
  - ä¾‹ï¼šã€Œãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†æ©Ÿèƒ½ã€ã€Œé€šçŸ¥æ©Ÿèƒ½ã€
- **å°è¦æ¨¡é–‹ç™ºï¼ˆæ”¹è‰¯ï¼‰**: ç´°ã‹ã„ç²’åº¦
  - ä¾‹ï¼šã€Œæ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¿½åŠ ã€ã€ŒUIæ”¹å–„ã€

**ğŸ› bugfixï¼ˆãƒã‚°ä¿®æ­£ï¼‰**ï¼š
- **å¸¸ã«ç´°ã‹ã„ç²’åº¦**ã§å®Ÿè£…
- é–¢é€£ã™ã‚‹ãƒã‚°ãŒè¤‡æ•°ã‚ã‚‹å ´åˆã®ã¿ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
- ä¾‹ï¼šã€Œãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã§ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ä¿®æ­£ã€ã€Œå•†å“ä¸€è¦§ã®è¡¨ç¤ºãƒã‚°ä¿®æ­£ã€

**ğŸ§ª testï¼ˆãƒ†ã‚¹ãƒˆè¿½åŠ ï¼‰**ï¼š
- å¯¾å¿œã™ã‚‹æ©Ÿèƒ½ã®è¦æ¨¡ã«åˆã‚ã›ã¦èª¿æ•´
- ä¾‹ï¼šã€Œèªè¨¼æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆè¿½åŠ ã€ã€Œå€‹åˆ¥APIã®ãƒ†ã‚¹ãƒˆä¿®æ­£ã€

**ğŸ“š documentationï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰**ï¼š
- ç´°ã‹ã„ç²’åº¦ã§å®Ÿè£…
- ä¾‹ï¼šã€ŒAPIä»•æ§˜æ›¸æ›´æ–°ã€ã€ŒREADMEæ”¹å–„ã€

**ğŸ”§ refactoringï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼‰**ï¼š
- ä¸­ç¨‹åº¦ã®ç²’åº¦
- ä¾‹ï¼šã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã€ã€Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–ã€

#### ğŸ¯ å®Ÿè·µæŒ‡é‡

**ã‚¢ãƒ—ãƒª0â†’MVPé–‹ç™ºã®å ´åˆ**ï¼š
- æ ¸å¿ƒæ©Ÿèƒ½ã‚’é©åˆ‡ãªç²’åº¦ã§åˆ†å‰²
- å„æ©Ÿèƒ½ãŒç‹¬ç«‹ã—ã¦ä¾¡å€¤ã‚’æä¾›ã§ãã‚‹ã‚ˆã†è¨­è¨ˆ
- ä¾‹ï¼šã€Œèªè¨¼æ©Ÿèƒ½ã€ã€Œå•†å“ç®¡ç†æ©Ÿèƒ½ã€ã€Œæ±ºæ¸ˆæ©Ÿèƒ½ã€ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ã€ã€Œæ³¨æ–‡ç®¡ç†æ©Ÿèƒ½ã€ãªã©å¿…è¦ãªæ©Ÿèƒ½ã‚’å…¨ã¦åˆ†å‰²

**æ—¢å­˜ã‚¢ãƒ—ãƒªã®æ©Ÿèƒ½è¿½åŠ ã®å ´åˆ**ï¼š
- è¿½åŠ æ©Ÿèƒ½ã‚’å®Œçµã—ãŸå˜ä½ã§åˆ†å‰²
- æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®çµ±åˆã‚‚å«ã‚ã¦ä¸€ã¤ã®ã‚¿ã‚¹ã‚¯ã§å®Œçµ

**ãƒã‚°ä¿®æ­£ãƒ»æ”¹å–„ã®å ´åˆ**ï¼š
- ç´°ã‹ã„ç²’åº¦ã§åˆ†å‰²ã—ã€è¿…é€Ÿãªä¿®æ­£ã‚’å„ªå…ˆ
- é–¢é€£æ€§ã®é«˜ã„ãƒã‚°ã®ã¿ã‚°ãƒ«ãƒ¼ãƒ—åŒ–

## ğŸš¨ é‡è¦ãªæŒ‡é‡

### ğŸª å®Ÿè·µçš„ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆåˆ¤æ–­

#### ğŸ§  ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã¨ã—ã¦ã®æ„æ€æ±ºå®š
**ProductOwnerå…¼ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã¨ã—ã¦ä»¥ä¸‹ã‚’ç·åˆåˆ¤æ–­**ï¼š

1. **é–‹ç™ºåŠ¹ç‡ vs ç«¶åˆãƒªã‚¹ã‚¯**ï¼š
   - å®Œå…¨å›é¿ã§å·¥æ•°ãŒ2å€ã«ãªã‚‹ â†’ é©åº¦ãªç«¶åˆã‚’è¨±å®¹
   - è»½å¾®ãªç«¶åˆã§é–‹ç™ºé€Ÿåº¦ãŒå¤§å¹…æ”¹å–„ â†’ ç©æ¥µçš„ã«ä¸¦åˆ—åŒ–
   - é«˜ãƒªã‚¹ã‚¯ç«¶åˆï¼ˆDB migrationç­‰ï¼‰ â†’ å¿…ãšå›é¿

2. **ã‚·ã‚¹ãƒ†ãƒ ç”Ÿç”£æ€§ã®æœ€å¤§åŒ–**ï¼š
   - ä¸¦åˆ—å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’æ´»ã‹ã—ãŸæœ€é©ãªã‚¿ã‚¹ã‚¯åˆ†å‰²
   - æ©Ÿèƒ½ã®ç‹¬ç«‹æ€§ã‚’é‡è¦–ã—ãŸã‚¿ã‚¹ã‚¯è¨­è¨ˆ
   - ãƒ–ãƒ­ãƒƒã‚«ãƒ¼æœ€å°åŒ–ã¨ãƒ•ãƒ­ãƒ¼åŠ¹ç‡ã®å‘ä¸Š

3. **å“è³ªã¨ã‚¹ãƒ”ãƒ¼ãƒ‰ã®ãƒãƒ©ãƒ³ã‚¹**ï¼š
   - MVPåˆ°é”é€Ÿåº¦ã®å„ªå…ˆåº¦
   - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ä½™åœ°ã®ç¢ºä¿
   - æŠ€è¡“çš„è² å‚µã®è¨±å®¹ç¯„å›²

#### ğŸ”„ å‹•çš„ãƒªã‚¹ã‚¯èª¿æ•´
- **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«**: 1ã¤ã®ã‚¿ã‚¹ã‚¯ã«é›†ç´„ï¼ˆé«˜ãƒªã‚¹ã‚¯å›é¿ï¼‰
- **ç‹¬ç«‹æ©Ÿèƒ½**: ç©æ¥µçš„ä¸¦åˆ—åŒ–ï¼ˆåŠ¹ç‡å„ªå…ˆï¼‰
- **å…±é€šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**: è»½å¾®å¤‰æ›´ã¯è¨±å®¹ã€å¤§å¹…å¤‰æ›´ã¯åˆ†é›¢
- **ãƒ†ã‚¹ãƒˆãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: ç«¶åˆã‚’æã‚Œãšä¸¦åˆ—å®Ÿè¡Œ

#### ğŸ“Š æˆæœé‡è¦–ã®åˆ¤æ–­åŸºæº–
ç«¶åˆã«ã‚ˆã‚‹é–‹ç™ºåœæ­¢ < ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ¶ˆã‚³ã‚¹ãƒˆ < ä¸¦åˆ—åŒ–ã«ã‚ˆã‚‹æ™‚é–“çŸ­ç¸®åŠ¹æœ

#### ğŸ¯ å®Ÿè·µçš„ãªfileScopeã®è¨­å®šæŒ‡é‡
**conflictRiskè©•ä¾¡ã®ç¾å®Ÿçš„ãªåŸºæº–**ï¼š
- **none**: å®Œå…¨ã«ç‹¬ç«‹ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ»æ©Ÿèƒ½
- **low**: è»½å¾®ãªå…±é€šãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ï¼ˆimportè¿½åŠ ã€å‹å®šç¾©è¿½åŠ ç­‰ï¼‰
- **medium**: å…±é€šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®éƒ¨åˆ†çš„å¤‰æ›´
- **high**: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã€DB migrationã€èªè¨¼ç³»ã®åŒæ™‚å¤‰æ›´

**åˆ¤æ–­ä¾‹**ï¼š
- âœ… ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†API + å•†å“ç®¡ç†APIã€â†’ low riskï¼ˆå‹å®šç¾©ã®è»½å¾®ãªç«¶åˆã®ã¿ï¼‰
- âœ… ã€Œãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ + ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã€â†’ low riskï¼ˆç•°ãªã‚‹æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ï¼‰
- âš ï¸ ã€Œpackage.jsonè¨­å®š + è¤‡æ•°æ©Ÿèƒ½å®Ÿè£…ã€â†’ high riskï¼ˆè¨­å®šç«¶åˆã‚’å›é¿ï¼‰

## ğŸ”„ ä¾å­˜é–¢ä¿‚è¨­è¨ˆã®é‡è¦æŒ‡é‡

### âš ï¸ å¾ªç’°ä¾å­˜ã®å®Œå…¨å›é¿
**é‡è¦**: ã‚¿ã‚¹ã‚¯é–“ã®ä¾å­˜é–¢ä¿‚ã§å¾ªç’°å‚ç…§ã‚’çµ¶å¯¾ã«ä½œã‚‰ãªã„ã§ãã ã•ã„ã€‚

#### ğŸš¨ é¿ã‘ã‚‹ã¹ããƒ‘ã‚¿ãƒ¼ãƒ³
- ã‚¿ã‚¹ã‚¯A â†’ ã‚¿ã‚¹ã‚¯B â†’ ã‚¿ã‚¹ã‚¯Aï¼ˆç›´æ¥çš„å¾ªç’°ï¼‰
- ã‚¿ã‚¹ã‚¯A â†’ ã‚¿ã‚¹ã‚¯B â†’ ã‚¿ã‚¹ã‚¯C â†’ ã‚¿ã‚¹ã‚¯Aï¼ˆé–“æ¥çš„å¾ªç’°ï¼‰
- ç›¸äº’ä¾å­˜é–¢ä¿‚ï¼ˆã‚¿ã‚¹ã‚¯Aã¨ã‚¿ã‚¹ã‚¯BãŒäº’ã„ã«ä¾å­˜ï¼‰

#### âœ… æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³
- **éšå±¤çš„ä¾å­˜**: åŸºç›¤ â†’ æ©Ÿèƒ½ â†’ çµ±åˆ ã®ä¸€æ–¹å‘ãƒ•ãƒ­ãƒ¼
- **ä¾å­˜æœ€å°åŒ–**: å¯èƒ½ãªé™ã‚Šç‹¬ç«‹ã—ãŸã‚¿ã‚¹ã‚¯ã¨ã—ã¦è¨­è¨ˆ
- **æ˜ç¢ºãªé †åº**: è«–ç†çš„ãªå®Ÿè£…é †åºã§ã®ä¾å­˜é–¢ä¿‚è¨­å®š`;
  }

  /**
   * ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è©³ç´°ãªèª¬æ˜ã‚’æ§‹ç¯‰
   */
  private buildTaskDescription(taskData: any): string {
    let description = taskData.description || 'ã‚¿ã‚¹ã‚¯ã®èª¬æ˜';

    // æ©Ÿèƒ½è¦ä»¶ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
    if (taskData.functionalRequirements) {
      description += '\n\n## ğŸ“‹ æ©Ÿèƒ½è¦ä»¶';
      if (taskData.functionalRequirements.userStories) {
        description += '\n### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼';
        taskData.functionalRequirements.userStories.forEach((story: string) => {
          description += `\n- ${story}`;
        });
      }
      if (taskData.functionalRequirements.useCases) {
        description += '\n### ä½¿ç”¨ã‚·ãƒŠãƒªã‚ª';
        taskData.functionalRequirements.useCases.forEach((useCase: string) => {
          description += `\n- ${useCase}`;
        });
      }
      if (taskData.functionalRequirements.businessRules) {
        description += '\n### ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«';
        taskData.functionalRequirements.businessRules.forEach((rule: string) => {
          description += `\n- ${rule}`;
        });
      }
    }

    // å“è³ªè¦ä»¶ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
    if (taskData.qualityRequirements) {
      description += '\n\n## ğŸ¯ å“è³ªè¦ä»¶';
      if (taskData.qualityRequirements.usability) {
        description += '\n### ä½¿ã„ã‚„ã™ã•è¦ä»¶';
        taskData.qualityRequirements.usability.forEach((req: string) => {
          description += `\n- ${req}`;
        });
      }
      if (taskData.qualityRequirements.security) {
        description += '\n### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶';
        taskData.qualityRequirements.security.forEach((req: string) => {
          description += `\n- ${req}`;
        });
      }
    }

    // çµ±åˆè¦ä»¶ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
    if (taskData.integrationRequirements) {
      description += '\n\n## ğŸ”— çµ±åˆè¦ä»¶';
      if (taskData.integrationRequirements.externalSystems) {
        description += '\n### å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ é€£æº';
        taskData.integrationRequirements.externalSystems.forEach((req: string) => {
          description += `\n- ${req}`;
        });
      }
      if (taskData.integrationRequirements.internalModules) {
        description += '\n### å†…éƒ¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é€£æº';
        taskData.integrationRequirements.internalModules.forEach((req: string) => {
          description += `\n- ${req}`;
        });
      }
      if (taskData.integrationRequirements.dataFlow) {
        description += '\n### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼';
        taskData.integrationRequirements.dataFlow.forEach((req: string) => {
          description += `\n- ${req}`;
        });
      }
    }

    // å—ã‘å…¥ã‚ŒåŸºæº–ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
    if (taskData.acceptanceCriteria) {
      description += '\n\n## âœ… å—ã‘å…¥ã‚ŒåŸºæº–';
      taskData.acceptanceCriteria.forEach((criteria: string) => {
        description += `\n- ${criteria}`;
      });
    }

    // ã‚¹ã‚­ãƒ«è¦ä»¶ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
    if (taskData.skillRequirements) {
      description += '\n\n## ğŸ‘¨â€ğŸ’» å¿…è¦ã‚¹ã‚­ãƒ«';
      description += `\n- ${taskData.skillRequirements.join(', ')}`;
    }


    return description;
  }

  /**
   * ã‚¿ã‚¹ã‚¯ã®è©³ç´°æŒ‡ç¤ºã‚’ç”Ÿæˆ
   */
  private async generateDetailedInstructions(task: Task, userRequest: string, analysis: string): Promise<string> {
    // ã‚·ãƒ³ãƒ—ãƒ«ã§æ˜ç¢ºãªæŒ‡ç¤ºæ›¸ã‚’ç”Ÿæˆ
    return `
# ã‚¿ã‚¹ã‚¯: ${task.title}

## ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æ±‚
${userRequest}

## ã“ã®ã‚¿ã‚¹ã‚¯ã®è¦ä»¶
${task.description}

## ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚ªãƒ¼ãƒŠãƒ¼ã«ã‚ˆã‚‹åˆ†æ
${analysis}

## å®Ÿè£…ã«ãŠã‘ã‚‹æ–¹é‡
- ä¸Šè¨˜ã®è¦ä»¶ã‚’æº€ãŸã™ãŸã‚ã®æœ€é©ãªå®Ÿè£…æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„
- æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã¨ã®æ•´åˆæ€§ã‚’ä¿ã£ã¦ãã ã•ã„  
- æŠ€è¡“é¸æŠã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆã€ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã¯ã‚ãªãŸãŒæ±ºå®šã—ã¦ãã ã•ã„
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ä¿å®ˆæ€§ã‚’è€ƒæ…®ã—ãŸå®Ÿè£…ã‚’è¡Œã£ã¦ãã ã•ã„
`;
  }

  /**
   * ä¿å­˜ã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¿ã‚¹ã‚¯åˆ†æçµæœã‚’æŠ½å‡º
   */
  private async extractTaskAnalysisResultFromFile(projectId: string, messages: SDKMessage[]): Promise<TaskAnalysisResult> {
    const analysisPath = this.getAnalysisJsonPath(projectId);

    try {
      // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
      await fs.access(analysisPath);

      const content = await fs.readFile(analysisPath, 'utf-8');
      const jsonData = JSON.parse(content);

      this.info(`ğŸ“„ åˆ†æçµæœJSONã‚’èª­ã¿è¾¼ã¿: ${jsonData.tasks?.length || 0}å€‹ã®ã‚¿ã‚¹ã‚¯`);

      // ã‚¿ã‚¹ã‚¯ã‚’å¤‰æ›
      const tasks: Task[] = (jsonData.tasks || []).map((taskData: any) => {
        const description = this.buildTaskDescription(taskData);

        return {
          id: uuidv4(),
          type: taskData.type || 'feature',
          title: taskData.title || 'ã‚¿ã‚¹ã‚¯',
          description: description,
          priority: taskData.priority || 'medium',
          status: 'pending',
          dependencies: taskData.dependencies || [],
          createdAt: new Date(),
          updatedAt: new Date(),
          metadata: {
            skillRequirements: taskData.skillRequirements,
            functionalRequirements: taskData.functionalRequirements,
            qualityRequirements: taskData.qualityRequirements,
            integrationRequirements: taskData.integrationRequirements,
            acceptanceCriteria: taskData.acceptanceCriteria,
            constraints: taskData.constraints,
            successMetrics: taskData.successMetrics
          }
        };
      });

      if (tasks.length > 0) {
        const analysis = jsonData.analysis || {};
        const riskAssessment = typeof jsonData.riskAssessment === 'object'
          ? `ãƒªã‚¹ã‚¯: ${(jsonData.riskAssessment.risks || []).join(', ')}\nè»½æ¸›ç­–: ${(jsonData.riskAssessment.mitigations || []).join(', ')}`
          : jsonData.riskAssessment || 'ãƒªã‚¹ã‚¯è©•ä¾¡ãªã—';

        return {
          tasks,
          summary: jsonData.summary || analysis.userRequestAnalysis || 'ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚ªãƒ¼ãƒŠãƒ¼AIã«ã‚ˆã‚‹åˆ†æçµæœ',
          riskAssessment: riskAssessment,
          analysisDetails: {
            codebaseAssessment: analysis.codebaseAssessment,
            technicalRequirements: analysis.technicalRequirements,
            architecturalDecisions: analysis.architecturalDecisions,
            parallelizationStrategy: jsonData.parallelizationStrategy
          }
        };
      }

      throw new Error('ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');

    } catch (error) {
      this.error('âŒ åˆ†æçµæœJSONãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', {
        error: error instanceof Error ? error.message : String(error),
        path: analysisPath
      });

      // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¿½åŠ 
      const projectDir = path.dirname(analysisPath);
      try {
        const files = await fs.readdir(projectDir);
        this.info('ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹:', { files });
      } catch (e) {
        this.error('âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“', { projectDir });
      }

      throw new Error(`ã‚¿ã‚¹ã‚¯åˆ†æçµæœãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ: ${analysisPath}`);
    }
  }

  /**
   * Claude Code SDKã®å¿œç­”ã‹ã‚‰ã‚¿ã‚¹ã‚¯åˆ†æçµæœã‚’æŠ½å‡ºï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
   */
  private extractTaskAnalysisResult(messages: SDKMessage[]): TaskAnalysisResult {
    // å…¨ã¦ã®åˆ†æãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰çµæœã‚’æŠ½å‡º
    let fullAnalysisText = '';

    for (const message of messages) {
      if (message && typeof message === 'object' && 'type' in message) {
        if (message.type === 'assistant' && 'message' in message) {
          const assistantMessage = message.message as any;
          if (assistantMessage.content) {
            for (const content of assistantMessage.content) {
              if (content.type === 'text') {
                fullAnalysisText += content.text + '\n';
              }
            }
          }
        } else if (message.type === 'result') {
          fullAnalysisText += (message as any).result || '';
        }
      }
    }

    // JSONãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠ½å‡ºï¼ˆæœ€å¾Œã®ã‚‚ã®ã‚’å„ªå…ˆï¼‰
    const jsonMatches = [...fullAnalysisText.matchAll(/```json\s*([\s\S]*?)\s*```/g)];

    if (jsonMatches.length > 0) {
      // æœ€å¾Œã®JSONãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨
      const lastJsonMatch = jsonMatches[jsonMatches.length - 1];
      try {
        const jsonData = JSON.parse(lastJsonMatch[1]);

        this.info(`ğŸ“‹ JSONã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’æ¤œå‡º: ${jsonData.tasks?.length || 0}å€‹ã®ã‚¿ã‚¹ã‚¯`);

        // æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¨æ—§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ä¸¡æ–¹ã‚’ã‚µãƒãƒ¼ãƒˆ
        const tasks: Task[] = (jsonData.tasks || []).map((taskData: any) => {
          // è©³ç´°ãªæŒ‡ç¤ºæƒ…å ±ã‚’å«ã‚€æ‹¡å¼µã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
          const description = this.buildTaskDescription(taskData);

          return {
            id: uuidv4(),
            type: taskData.type || 'feature',
            title: taskData.title || 'ã‚¿ã‚¹ã‚¯',
            description: description,
            priority: taskData.priority || 'medium',
            status: 'pending',
            dependencies: taskData.dependencies || [],
            createdAt: new Date(),
            updatedAt: new Date(),
            // è¦ä»¶æƒ…å ±ã‚’ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿å­˜
            metadata: {
              skillRequirements: taskData.skillRequirements,
              functionalRequirements: taskData.functionalRequirements,
              qualityRequirements: taskData.qualityRequirements,
              integrationRequirements: taskData.integrationRequirements,
              acceptanceCriteria: taskData.acceptanceCriteria,
              constraints: taskData.constraints,
              successMetrics: taskData.successMetrics
            }
          };
        });


        if (tasks.length > 0) {
          // æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®åˆ†ææƒ…å ±ã‚’çµ±åˆ
          const analysis = jsonData.analysis || {};
          const riskAssessment = typeof jsonData.riskAssessment === 'object'
            ? `ãƒªã‚¹ã‚¯: ${(jsonData.riskAssessment.risks || []).join(', ')}\nè»½æ¸›ç­–: ${(jsonData.riskAssessment.mitigations || []).join(', ')}`
            : jsonData.riskAssessment || 'ãƒªã‚¹ã‚¯è©•ä¾¡ãªã—';

          return {
            tasks,
            summary: jsonData.summary || analysis.userRequestAnalysis || 'ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚ªãƒ¼ãƒŠãƒ¼AIã«ã‚ˆã‚‹åˆ†æçµæœ',
            riskAssessment: riskAssessment,
            // æ‹¡å¼µåˆ†ææƒ…å ±
            analysisDetails: {
              codebaseAssessment: analysis.codebaseAssessment,
              technicalRequirements: analysis.technicalRequirements,
              architecturalDecisions: analysis.architecturalDecisions,
              parallelizationStrategy: jsonData.parallelizationStrategy
            }
          };
        }

      } catch (error) {
        this.error('âŒ JSONè§£æã‚¨ãƒ©ãƒ¼', { error: error instanceof Error ? error.message : String(error) });
        this.error('âŒ å•é¡Œã®ã‚ã‚‹JSON', { json: lastJsonMatch[1] });
        throw new Error(`ã‚¿ã‚¹ã‚¯åˆ†æçµæœã®JSONè§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ${error instanceof Error ? error.message : String(error)}`);
      }
    }

    // JSONå½¢å¼ã®åˆ†æçµæœãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
    this.error('âŒ JSONå½¢å¼ã®åˆ†æçµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    throw new Error('ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚ªãƒ¼ãƒŠãƒ¼AIãŒJSONå½¢å¼ã§ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’å‡ºåŠ›ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚åˆ†æçµæœã®å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
  }

  /**
   * ã‚¿ã‚¹ã‚¯ã®ä¾å­˜é–¢ä¿‚ã‚’è§£æ±ºã—ã¦å®Ÿè¡Œé †åºã‚’æ±ºå®š
   */
  resolveDependencies(tasks: Task[]): Task[] {
    const resolved: Task[] = [];
    const remaining = [...tasks];

    while (remaining.length > 0) {
      const before = remaining.length;

      for (let i = remaining.length - 1; i >= 0; i--) {
        const task = remaining[i];

        // ä¾å­˜é–¢ä¿‚ãŒã™ã¹ã¦è§£æ±ºã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const dependenciesResolved = task.dependencies.every(depTitle =>
          resolved.some(resolvedTask => resolvedTask.title === depTitle)
        );

        if (dependenciesResolved) {
          resolved.push(task);
          remaining.splice(i, 1);
        }
      }

      // å¾ªç’°ä¾å­˜ã®ãƒã‚§ãƒƒã‚¯
      if (remaining.length === before && remaining.length > 0) {
        // è©³ç´°ãªå¾ªç’°ä¾å­˜æƒ…å ±ã‚’ãƒ­ã‚°å‡ºåŠ›
        const cyclicTasks = remaining.map(task => ({
          title: task.title,
          dependencies: task.dependencies
        }));

        this.warn('âš ï¸ å¾ªç’°ä¾å­˜ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚è©³ç´°:');
        cyclicTasks.forEach(task => {
          this.warn(`   - "${task.title}" â†’ ä¾å­˜: [${task.dependencies.join(', ')}]`);
        });

        // ä¾å­˜é–¢ä¿‚ã‚’ç„¡è¦–ã—ã¦æ®‹ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
        const tasksWithoutDeps = remaining.map(task => ({
          ...task,
          dependencies: [] // å¾ªç’°ä¾å­˜ã‚’è§£æ¶ˆ
        }));

        resolved.push(...tasksWithoutDeps);
        this.info('ğŸ“ å¾ªç’°ä¾å­˜ã‚’è§£æ¶ˆã—ã¦ç¶šè¡Œã—ã¾ã™');
        break;
      }
    }

    return resolved;
  }

  /**
   * ç¶™ç¶šå®Ÿè¡Œç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
   */
  private buildContinuationPrompt(userRequest: string, existingDoc: PhaseDocument, sessionId?: string): string {
    const allPhaseDescriptions = existingDoc.phases.map((phase, idx) =>
      `${idx + 1}. ${phase.phaseName}: ${phase.description}`
    ).join('\n');

    return `
ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚ªãƒ¼ãƒŠãƒ¼ã¨ã—ã¦ã€ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†ã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç¶šãã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

## ğŸ“ å…ƒã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æ±‚
${userRequest}

## ğŸ“Š ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ•ã‚§ãƒ¼ã‚ºæ§‹æˆ
${allPhaseDescriptions}

## ğŸ” å¾¹åº•çš„ãªå®Ÿè£…çŠ¶æ³åˆ†æ

### ğŸ“‹ å¿…é ˆèª¿æŸ»é …ç›®
ä»¥ä¸‹ã‚’å¿…ãšç¢ºèªã—ã€ç¾åœ¨ã®çŠ¶æ³ã‚’æ­£ç¢ºã«æŠŠæ¡ã—ã¦ãã ã•ã„ï¼š

1. **ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹å®Ÿè£…çŠ¶æ³**ï¼š
   - å„ãƒ•ã‚§ãƒ¼ã‚ºã®ã‚¿ã‚¹ã‚¯ãŒå®Ÿéš›ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹ã®è©³ç´°ç¢ºèª
   - å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½ã®å‹•ä½œçŠ¶æ³ãƒ»å“è³ªãƒ¬ãƒ™ãƒ«ã®è©•ä¾¡
   - æœªå®Œæˆãƒ»éƒ¨åˆ†å®Ÿè£…ã®æ©Ÿèƒ½ã®ç‰¹å®š

2. **æŠ€è¡“çš„è² å‚µãƒ»èª²é¡Œã®æ´—ã„å‡ºã—**ï¼š
   - æ—¢å­˜å®Ÿè£…ã®æŠ€è¡“çš„å•é¡Œç‚¹ã®ç‰¹å®š
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£èª²é¡Œã®ç¢ºèª
   - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ãŒå¿…è¦ãªç®‡æ‰€ã®ç‰¹å®š

3. **MVPå®Œæˆåº¦è©•ä¾¡**ï¼š
   - ç¾åœ¨ã®å®Ÿè£…ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®Ÿéš›ã«ä½¿ç”¨å¯èƒ½ãªæ©Ÿèƒ½ç¯„å›²
   - ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½æ€§ãƒ»å‹•ä½œå®‰å®šæ€§ã®è©•ä¾¡
   - å®Œæˆã¾ã§ã«å¿…è¦ãªæ®‹ä½œæ¥­ã®æ­£ç¢ºãªè¦‹ç©ã‚‚ã‚Š

4. **æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã®é©å¿œåˆ¤æ–­**ï¼š
   - å½“åˆè¨ˆç”»ã¨ç¾å®Ÿã®å®Ÿè£…çŠ¶æ³ã®å·®ç•°åˆ†æ
   - æŠ€è¡“çš„ç™ºè¦‹ãƒ»åˆ¶ç´„ã«ã‚ˆã‚‹è¨ˆç”»å¤‰æ›´ã®å¿…è¦æ€§åˆ¤æ–­
   - å„ªå…ˆåº¦ãƒ»ã‚¹ã‚³ãƒ¼ãƒ—ã®å†è©•ä¾¡

## ğŸ”„ ãƒ•ã‚§ãƒ¼ã‚ºå†…å®¹ã®æ›´æ–°
å®Ÿè£…çŠ¶æ³ã‚„æ–°ãŸãªç™ºè¦‹ã«åŸºã¥ã„ã¦ã€å¿…è¦ã«å¿œã˜ã¦ä»¥ä¸‹ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ï¼š
- ä»Šå¾Œã®ãƒ•ã‚§ãƒ¼ã‚ºã®å†…å®¹ã‚„ã‚¿ã‚¹ã‚¯æ§‹æˆ
- å„ãƒ•ã‚§ãƒ¼ã‚ºã®èª¬æ˜ã‚„ç›®çš„
- è¦‹ç©ã‚‚ã‚Šæ™‚é–“ã‚„å„ªå…ˆåº¦

ã“ã‚Œã‚‰ã®æ›´æ–°ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é€²åŒ–ã«åˆã‚ã›ã¦æŸ”è»Ÿã«å¯¾å¿œã—ã€ã‚ˆã‚Šé©åˆ‡ãªå®Ÿè£…è¨ˆç”»ã«èª¿æ•´ã—ã¦ãã ã•ã„ã€‚

## ğŸ“‹ å®Ÿè¡Œã™ã¹ãã‚¿ã‚¹ã‚¯
å®Ÿè£…çŠ¶æ³ã®ç¢ºèªçµæœã«åŸºã¥ã„ã¦ã€ç¾åœ¨å®Ÿè¡Œã™ã¹ããƒ•ã‚§ãƒ¼ã‚ºã®ã‚¿ã‚¹ã‚¯ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
ãƒ•ã‚§ãƒ¼ã‚ºå†…å®¹ã‚’æ›´æ–°ã—ãŸå ´åˆã¯ã€"phaseManagement"ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§æ›´æ–°å†…å®¹ã‚‚å«ã‚ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

${this.buildAnalysisPrompt(userRequest, existingDoc.projectId, sessionId).split('## ğŸ“Š æœ€çµ‚æˆæœç‰©è¦æ±‚')[1]}`;
  }

  /**
   * JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ã‚’æŠ½å‡º
   */
  private async extractPhaseInfoFromFile(projectId: string): Promise<any | null> {
    const analysisPath = this.getAnalysisJsonPath(projectId);

    try {
      const content = await fs.readFile(analysisPath, 'utf-8');
      const jsonData = JSON.parse(content);

      if (jsonData.phaseManagement && jsonData.phaseManagement.requiresPhases) {
        this.info('ğŸ“Š ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†ãŒå¿…è¦ã¨åˆ¤æ–­ã•ã‚Œã¾ã—ãŸ');
        return jsonData.phaseManagement;
      }
    } catch (error) {
      // ãƒ•ã‚¡ã‚¤ãƒ«ãŒã¾ã å­˜åœ¨ã—ãªã„ã‹ã€ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ãŒãªã„
    }

    return null;
  }

  /**
   * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ã‚’æŠ½å‡ºï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
   */
  private extractPhaseInfo(messages: SDKMessage[]): any | null {
    let fullText = '';

    for (const message of messages) {
      if (message && typeof message === 'object' && 'type' in message) {
        if (message.type === 'assistant' && 'message' in message) {
          const assistantMessage = message.message as any;
          if (assistantMessage.content) {
            for (const content of assistantMessage.content) {
              if (content.type === 'text') {
                fullText += content.text + '\n';
              }
            }
          }
        }
      }
    }

    // ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†ã®JSONãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¢ã™ - ã‚ˆã‚Šå …ç‰¢ãªæ–¹æ³•
    const jsonBlocks = [...fullText.matchAll(/```json\s*([\s\S]*?)\s*```/g)];

    for (const jsonBlock of jsonBlocks.reverse()) { // æœ€å¾Œã‹ã‚‰æ¤œç´¢
      try {
        const jsonData = JSON.parse(jsonBlock[1]);
        if (jsonData.phaseManagement && jsonData.phaseManagement.requiresPhases) {
          this.info('ğŸ“Š ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†ãŒå¿…è¦ã¨åˆ¤æ–­ã•ã‚Œã¾ã—ãŸ');
          return jsonData.phaseManagement;
        }
      } catch (error) {
        // ã“ã®JSONãƒ–ãƒ­ãƒƒã‚¯ã¯ç„¡åŠ¹ã€æ¬¡ã‚’è©¦ã™
        continue;
      }
    }

    // ä»£æ›¿æ‰‹æ®µ: "phaseManagement"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢
    if (fullText.includes('"phaseManagement"') && fullText.includes('"requiresPhases"')) {
      this.warn('âš ï¸ ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ã¯å­˜åœ¨ã—ã¾ã™ãŒã€JSONè§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
    }

    return null;
  }

  /**
   * åˆ†æçµæœã‹ã‚‰ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’æŠ½å‡º
   */
  private extractCurrentPhaseFromAnalysis(messages: SDKMessage[]): { phaseNumber: number } | null {
    let fullText = '';

    for (const message of messages) {
      if (message && typeof message === 'object' && 'type' in message) {
        if (message.type === 'assistant' && 'message' in message) {
          const assistantMessage = message.message as any;
          if (assistantMessage.content) {
            for (const content of assistantMessage.content) {
              if (content.type === 'text') {
                fullText += content.text + '\n';
              }
            }
          }
        }
      }
    }

    // ã€Œç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºã€ã€Œå®Ÿè£…çŠ¶æ³ã€ã€Œãƒ•ã‚§ãƒ¼ã‚ºXã€ãªã©ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¢ã™
    const phasePatterns = [
      /ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚º[\sï¼š:]*ãƒ•ã‚§ãƒ¼ã‚º(\d+)/,
      /ãƒ•ã‚§ãƒ¼ã‚º(\d+)[\sã®]*å®Ÿè£…ãŒå®Œäº†/,
      /ãƒ•ã‚§ãƒ¼ã‚º(\d+)[\sã®]*ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè£…/,
      /å®Ÿè£…çŠ¶æ³[\sï¼š:]*ãƒ•ã‚§ãƒ¼ã‚º(\d+)/
    ];

    for (const pattern of phasePatterns) {
      const match = fullText.match(pattern);
      if (match && match[1]) {
        const phaseNumber = parseInt(match[1]);
        this.info(`ğŸ” ProductOwnerAIãŒãƒ•ã‚§ãƒ¼ã‚º ${phaseNumber} ã‚’æ¤œå‡ºã—ã¾ã—ãŸ`);
        return { phaseNumber };
      }
    }

    return null;
  }

  /**
   * ãƒ•ã‚§ãƒ¼ã‚ºãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã¾ãŸã¯æ›´æ–°
   */
  private async createOrUpdatePhaseDocument(
    projectId: string,
    userRequest: string,
    phaseInfo: any,
    result: TaskAnalysisResult,
    existingDoc: PhaseDocument | null
  ): Promise<PhaseDocument> {
    if (existingDoc) {
      // æ—¢å­˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™ï¼ˆæ›´æ–°ã¯ markTasksCompleted ã§è¡Œã†ï¼‰
      return existingDoc;
    } else {
      // æ–°è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä½œæˆ
      const phases: ProjectPhase[] = phaseInfo.phases.map((p: any, index: number) => ({
        currentPhase: p.phaseNumber || index + 1,
        totalPhases: phaseInfo.totalPhases,
        phaseName: p.phaseName,
        description: p.description,
        completedTasks: [],
        remainingTasks: p.phaseNumber === 1 ? result.tasks : [],
        createdAt: new Date(),
        updatedAt: new Date()
      }));

      return {
        projectId,
        userRequest,
        phases,
        currentPhaseIndex: 0,
        analysis: {
          summary: result.summary,
          technicalStrategy: result.analysisDetails?.architecturalDecisions || '',
          riskAssessment: result.riskAssessment
        },
        createdAt: new Date(),
        updatedAt: new Date()
      };
    }
  }

  /**
   * æ—¢å­˜ã®ãƒ•ã‚§ãƒ¼ã‚ºãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
   */
  private async updatePhaseDocument(
    existingDoc: PhaseDocument,
    updatedPhaseInfo: any,
    result: TaskAnalysisResult
  ): Promise<void> {
    // ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ã®æ›´æ–°
    if (updatedPhaseInfo.phases) {
      for (const updatedPhase of updatedPhaseInfo.phases) {
        const phaseIndex = (updatedPhase.phaseNumber || 1) - 1;
        if (phaseIndex < existingDoc.phases.length) {
          const phase = existingDoc.phases[phaseIndex];
          // ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ã‚’æ›´æ–°
          phase.phaseName = updatedPhase.phaseName || phase.phaseName;
          phase.description = updatedPhase.description || phase.description;
          phase.updatedAt = new Date();

          // ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºã®å ´åˆã¯ã‚¿ã‚¹ã‚¯ã‚‚æ›´æ–°
          if (phaseIndex === existingDoc.currentPhaseIndex) {
            phase.remainingTasks = result.tasks;
          }
        }
      }
    }

    // åˆ†ææƒ…å ±ã®æ›´æ–°
    if (result.analysisDetails) {
      existingDoc.analysis.technicalStrategy = result.analysisDetails.architecturalDecisions || existingDoc.analysis.technicalStrategy;
      existingDoc.analysis.riskAssessment = result.riskAssessment || existingDoc.analysis.riskAssessment;
    }

    existingDoc.updatedAt = new Date();
    await this.savePhaseDocument(existingDoc);
  }
}
